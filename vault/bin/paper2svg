#!/bin/bash 

fname=$(basename $1 | cut -d'.' -f1)
author=$(pdfinfo $1 | grep Creator | sed -e "s/Creator:[[:space:]]*//g")

# author = TeX if generated by pdflatex OR dvipdf OR ps2pdf 

if [[ $author == "TeX" || $author =~ ^dvips ]] ; then 
  # Output: tex-%d.svg 

  echo "TeX" 
  pdf2svg $1 $fname-%d.svg all 
  for f in `ls $fname*.svg` ; do 
    n=$(basename $f | cut -d'.' -f1 | cut -d'-' -f2)
    svgclip.py -o tex-$n.svg $f 
    rm -f $f 
  done 
else
  # Output: prefab-%d.svg 

  pdftoppm $1 pdf 

  for f in `ls pdf-*.ppm` ; do 
    n=$(basename $f | cut -d'.' -f1 | cut -d'-' -f2)
    
    # First Pass: PDF -> Trimmed PPM 

    potrace -g --tight $f 
    pgmfile=pdf-$n.pgm

    # Shave off 5% from left, right, top, bottom 

    dimensions=$(head -n3 $pgmfile | tail -n1)
    width=$(echo $dimensions | cut -d' ' -f1)
    height=$(echo $dimensions | cut -d' ' -f2)

    # echo $width $height

    let "deltax = $width / 50" 
    let "deltay = $height / 50" 

    let "left = $deltax" 
    let "right = $width - $deltax" 
    let "top = $deltay" 
    let "bottom = $height - $deltay" 

    pamcut -left $left -right $right -bottom $bottom -top $top $pgmfile > prefab-$n.pgm

    # Second Pass: Run potrace again to get cropped SVG

    potrace -s --tight --group -r 300 prefab-$n.pgm
  done 

  # Clean up 
  rm -f pdf-*.ppm prefab-*.pgm pdf-*.pgm 
fi 


