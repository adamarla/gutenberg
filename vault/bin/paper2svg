#!/bin/bash 

let cut_top=1
let cut_bottom=1
let cut_left=1
let cut_right=1

while getopts "l:t:r:b:q:n:k:" option ; do 
  case $option in 
    t) cut_top=$OPTARG ;;
    l) cut_left=$OPTARG ;;
    r) cut_right=$OPTARG ;;
    b) cut_bottom=$OPTARG ;;
    q) id=$OPTARG
       type="q" ;;
    n) id=$OPTARG
       type="snippets" ;;
    k) id=$OPTARG
       type="skills" ;;
    \?) exit 1 ;;
  esac
done 

if [ -z ${id+x} ] ; then 
  echo "[Error]: Specify one of -q|-n|-k <integer-id>" 
  exit 1
fi 

if [ $type == "q" ] ; then 
  dir_vault=$(readlink -f $(ls -d $VAULT/$type/*/$id))
  dir_tmp=$HOME/tmp/q/
else 
  dir_vault=$(readlink -f $(ls -d $VAULT/$type/$id))
  dir_tmp=$HOME/tmp/$type/
fi 

# Ensure $dir_tmp exists 
if [ ! -e $dir_tmp ] ;  then mkdir $dir_tmp ; fi 


# Get the last argument = TeX filename 
shift $((OPTIND-1))
src_pdf=$dir_tmp/scan.pdf 
cp $1 $src_pdf 
cd $dir_tmp 

# author = TeX if generated by pdflatex OR dvipdf OR ps2pdf 
author=$(pdfinfo scan.pdf | grep Creator | sed -e "s/Creator:[[:space:]]*//g")

if [[ $author == "TeX" || $author =~ ^dvips ]] ; then 
  # Output: tex-%d.svg 

  pdf2svg scan.pdf scan-%d.svg all 
  for f in `ls scan-*.svg` ; do 
    n=$(basename $f | cut -d'.' -f1 | cut -d'-' -f2)
    svgclip.py -o tex-$n.svg $f 
    rm -f $f 
  done 
else
  # Output: prefab-%d.svg 

  labels=$(printf "%c" {A..Z})
  let n_prefab=$(ls $id-*.eps | wc -l)

  pdftoppm scan.pdf pdf 

  echo "Generating ... "

  for f in `ls pdf-*.ppm` ; do 
    n=$(basename $f | cut -d'.' -f1 | cut -d'-' -f2)
    
    # First Pass: PDF -> Trimmed PPM 

    potrace -g --tight $f 
    pgmfile=pdf-$n.pgm

    dimensions=$(head -n3 $pgmfile | tail -n1)
    width=$(echo $dimensions | cut -d' ' -f1)
    height=$(echo $dimensions | cut -d' ' -f2)

    #echo "width = $width, height = $height"

    let "left = ($width * $cut_left) / 100"
    let "right = $width * (100-$cut_right) / 100"
    let "top = $height * $cut_top / 100" 
    let "bottom = $height * (100 - $cut_bottom)/ 100" 

    #echo "top = $top, bottom = $bottom, left = $left, right = $right" 
    pamcut -left $left -right $right -bottom $bottom -top $top $pgmfile > prefab-$n.pgm

    # Second Pass: Run potrace again to get cropped SVG
    potrace -s --tight --group -r 300 prefab-$n.pgm
    eps_name=$(echo $id-${labels:$n_prefab:1}.eps)

    echo "... $eps_name"
    inkscape -E $eps_name prefab-$n.svg  
    cp $eps_name $dir_vault/

    let n_prefab=n_prefab+1
  done 

  # Clean up 
  rm -f pdf-*.ppm prefab-*.{svg,pgm} pdf-*.pgm 
fi 

# cd back 
cd - 


