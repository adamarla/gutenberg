#!/bin/bash 

let cut_top=1
let cut_bottom=1
let cut_left=1
let cut_right=1

while getopts "l:t:r:b:qnkj:" option ; do 
  case $option in 
    t) cut_top=$OPTARG ;;
    l) cut_left=$OPTARG ;;
    r) cut_right=$OPTARG ;;
    b) cut_bottom=$OPTARG ;;
    q) type="q" ;;
    n) type="snippets" ;;
    k) type="skills" ;;
    j) id=$OPTARG ;;
    \?) exit 1 ;;
  esac
done 


# This bash command is to be called only on PDFs generated by the scanner 
# Anything else, and this should exit 

shift $((OPTIND-1))
generator=$(pdfinfo $1 | grep Creator | sed -e "s/Creator:[[:space:]]*//g")

if [[ $generator == "TeX" || $generator =~ ^dvips ]] ; then 
  echo "[Error]: Last argument should be a PDF generated by the scanner"
  exit 1
fi

if [ -z ${type+x} ] ;then 
  echo "[Error]: Specify a type using -q|-n|-k" 
  exit 1
elif [ -z ${id+x} ] ; then 
  echo "[Error]: Specify -j <id> along with -q|-n|-k" 
  exit 1
fi 

if [ $type == "q" ] ; then 
  dir_vault=$(readlink -f $(ls -d $VAULT/$type/*/$id))
  dir_tmp=$HOME/tmp/q/
else 
  dir_vault=$(readlink -f $(ls -d $VAULT/$type/$id))
  dir_tmp=$HOME/tmp/$type/
fi 

# Ensure $dir_tmp exists 
if [ ! -e $dir_tmp ] ;  then mkdir $dir_tmp ; fi 

# Copy to $dir_tmp and start processing 

src_pdf=$dir_tmp/scan.pdf 
cp $1 $src_pdf 
cd $dir_tmp 

# Output: prefab-%d.svg 

labels=$(printf "%c" {A..Z})
let n_prefab=$(ls $id-*.eps | wc -l)

pdftoppm scan.pdf pdf 

echo "Generating ... "

for f in `ls pdf-*.ppm` ; do 
  n=$(basename $f | cut -d'.' -f1 | cut -d'-' -f2)
  
  # First Pass: PDF -> Trimmed PPM 

  potrace -g --tight $f 
  pgmfile=pdf-$n.pgm

  dimensions=$(head -n3 $pgmfile | tail -n1)
  width=$(echo $dimensions | cut -d' ' -f1)
  height=$(echo $dimensions | cut -d' ' -f2)

  #echo "width = $width, height = $height"

  let "left = ($width * $cut_left) / 100"
  let "right = $width * (100-$cut_right) / 100"
  let "top = $height * $cut_top / 100" 
  let "bottom = $height * (100 - $cut_bottom)/ 100" 

  #echo "top = $top, bottom = $bottom, left = $left, right = $right" 
  pamcut -left $left -right $right -bottom $bottom -top $top $pgmfile > prefab-$n.pgm

  # Second Pass: Run potrace again to get cropped SVG
  potrace -s --tight --group -r 300 prefab-$n.pgm
  eps_name=$(echo $id-${labels:$n_prefab:1}.eps)

  echo "... $eps_name"
  inkscape -E $eps_name prefab-$n.svg  
  cp $eps_name $dir_vault/

  let n_prefab=n_prefab+1
done 

# Clean up 
rm -f pdf-*.ppm prefab-*.{svg,pgm} pdf-*.pgm 
# cd back 
cd - 

